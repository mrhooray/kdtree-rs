name: rust

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

env:
  CARGO_TERM_COLOR: always

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: rustfmt, clippy
      - run: cargo fmt --all --check
      - run: cargo clippy -- -Dwarnings
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
      - run: cargo test --all-features

  bench:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
      - run: cargo install critcmp
       - run: cargo bench --all-features
       - uses: actions/upload-artifact@v4
         with:
           name: bench-results-${{ github.sha }}
           path: target/criterion/
       - if: github.event_name == 'pull_request'
         run: |
           git fetch origin __bench_baseline__:baseline-branch
           if [ -f "baseline.json" ]; then
             echo "Comparing benchmarks against baseline..."
             critcmp baseline.json target/criterion/ || (
               echo "Performance regression detected!"
               echo "Run 'cargo bench --all-features' locally to verify changes."
               echo "If regression is expected, update baseline: git push origin __bench_baseline__"
               exit 1
             )
           else
             echo "No baseline found, skipping comparison"
           fi
       - if: github.ref == 'refs/heads/master'
         run: |
           git checkout __bench_baseline__ 2>/dev/null || git checkout -b __bench_baseline__
           critcmp --export base > baseline.json
           git add baseline.json
           git commit -m "update benchmark baseline $(date +%Y-%m-%d)" --allow-empty || echo "No changes to commit"
           git push origin __bench_baseline__
           git checkout master
